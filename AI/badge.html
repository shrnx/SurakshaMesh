<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurakshaMesh X - Site Intelligence Monitor</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* --- CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', 'Roboto', monospace;
            background: #050510; color: #c0c0c0; padding: 20px;
            min-height: 100vh; display: flex; flex-direction: column; gap: 20px;
        }
        
        /* HEADER */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 12px;
            border: 1px solid #333;
        }
        .brand h1 { color: #00ffff; font-size: 1.5em; margin-bottom: 5px; letter-spacing: 2px; }
        .status-indicator { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; }
        
        /* MAIN LAYOUT */
        .main-content {
            display: grid; grid-template-columns: 65% 35%; gap: 20px; height: 100%;
        }

        /* PANELS */
        .panel-header { 
            color: #fff; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* LEFT: WORKERS */
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .badge-card {
            background: #12121a; border: 1px solid #333; border-radius: 10px; padding: 15px;
            transition: transform 0.2s;
        }
        .badge-card:hover { transform: translateY(-2px); border-color: #555; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .w-id { color: #fff; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; }
        .action-text { color: #00ffff; font-size: 0.8em; margin-top: 10px; min-height: 1.2em; }

        /* RIGHT: SENSORS (The Update) */
        .env-panel {
            background: #0a0a0f; border: 1px solid #333; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; height: 85vh;
        }
        .env-feed {
            flex-grow: 1; overflow-y: auto; font-family: 'Courier New', monospace; 
            font-size: 0.85em; padding-right: 5px;
        }
        .env-entry {
            background: rgba(255,255,255,0.03); margin-bottom: 8px; padding: 10px;
            border-left: 3px solid #555; animation: fadeIn 0.3s ease;
            border-radius: 0 5px 5px 0;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; } }

        /* 3D CONTAINER */
        .digital-twin {
            height: 300px; background: #000; border-radius: 10px; margin-bottom: 20px;
            border: 1px solid #00ffff; position: relative; overflow: hidden;
        }
        .twin-overlay {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px;
            color: #00ffff; font-size: 0.8em; font-weight: bold; pointer-events: none;
        }
        model-viewer { width: 100%; height: 100%; background-color: #050510; }

        /* CONTROLS */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-norm { background: #00ff88; } .btn-warn { background: #ffaa00; } .btn-crit { background: #ff4444; color: #fff; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand">
            <h1>SurakshaMesh X</h1>
            <p>Integrated Digital Twin & Predictive Safety</p>
        </div>
        <div class="status-indicator">
            <span id="conn-dot" class="dot"></span>
            <span id="conn-text">SYSTEM ACTIVE</span>
        </div>
    </div>

    <div class="main-content">
        
        <div class="worker-panel">
            
            <div class="digital-twin">
                <div class="twin-overlay" id="twin-alert">LIVE TWIN | ZONE A</div>
                <model-viewer 
                    src="tunnel.glb" 
                    camera-controls auto-rotate shadow-intensity="1"
                    camera-orbit="45deg 55deg 2.5m">
                </model-viewer>
            </div>

            <h3 class="panel-header">
                <span>ðŸ‘· WORKER VITALS</span>
                <span style="font-size:0.8em; color:#888">UPDATING: 100ms</span>
            </h3>
            
            <div class="controls">
                <button class="btn-norm" onclick="setScenario('normal')">NORMAL</button>
                <button class="btn-warn" onclick="setScenario('stress')">STRESS</button>
                <button class="btn-crit" onclick="setScenario('emergency')">EMERGENCY</button>
            </div>

            <div id="worker-grid" class="badge-grid"></div>
        </div>

        <div class="env-panel">
            <h3 class="panel-header">
                <span>ðŸ“¡ SENSOR MESH</span>
                <span style="font-size:0.8em; color:#888">5 ACTIVE NODES</span>
            </h3>
            <div id="env-feed" class="env-feed">
                </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const BRAIN_WS = 'ws://localhost:8002/ws/brain'; // Optional: Only needed if you run Python
        let socket = null;
        let currentScenario = 'normal';
        
        // --- 1. WORKER DATA (Simulated) ---
        const workers = [
            { id: 'WKR-2401', name: 'Rajesh K.', zone: 'Furnace-A' },
            { id: 'WKR-2402', name: 'Amit S.', zone: 'Assembly-B' },
            { id: 'WKR-2403', name: 'Priya M.', zone: 'Tunnel-N' }
        ];
        let workerState = {};
        
        workers.forEach(w => {
            workerState[w.id] = { hr: 75, spo2: 98, risk: 10, action: "Monitoring" };
        });

        // --- 2. SENSOR DATA (Simulated Locally) ---
        const sensors = [
            { id: 'GAS-01', type: 'GAS', zone: 'Furnace', unit: 'ppm', base: 15, limit: 50 },
            { id: 'VIB-04', type: 'SEISMIC', zone: 'Wall-N', unit: 'g', base: 0.02, limit: 1.2 },
            { id: 'AUD-02', type: 'ACOUSTIC', zone: 'Gen-Room', unit: 'dB', base: 65, limit: 90 },
            { id: 'DST-09', type: 'DUST', zone: 'Exit-B', unit: 'Âµg/mÂ³', base: 40, limit: 150 },
            { id: 'TMP-01', type: 'THERMAL', zone: 'Core', unit: 'Â°C', base: 32, limit: 45 }
        ];
        let sensorState = {};
        sensors.forEach(s => sensorState[s.id] = s.base); // Init values

        // --- 3. SIMULATION LOOP (Runs Every 1.5s) ---
        function masterLoop() {
            updateWorkers();
            updateSensors();
            
            // Random chance to send data to Python Brain if connected
            if(socket && socket.readyState === WebSocket.OPEN && Math.random() > 0.7) {
                socket.send(JSON.stringify({ type: 'keepalive' })); 
            }
        }

        // --- WORKER LOGIC ---
        function updateWorkers() {
            const grid = document.getElementById('worker-grid');
            grid.innerHTML = '';

            workers.forEach(w => {
                const s = workerState[w.id];
                
                // Drift Logic
                let drift = (Math.random() - 0.5) * 5;
                if(currentScenario === 'stress') drift += 5;
                if(currentScenario === 'emergency') drift += 15;

                s.hr = Math.min(180, Math.max(60, Math.floor(s.hr + drift * 0.5)));
                
                // Calculate Risk
                if(s.hr > 150) s.risk = 95;
                else if(s.hr > 110) s.risk = 65;
                else s.risk = 15;

                // AI Action Text
                if(s.risk > 80) s.action = "ðŸš¨ EVACUATE NOW";
                else if(s.risk > 50) s.action = "âš ï¸ Take Break";
                else s.action = "âœ… Monitoring";

                // Render
                let color = s.risk > 80 ? '#ff4444' : (s.risk > 50 ? '#ffaa00' : '#00ff88');
                
                grid.innerHTML += `
                    <div class="badge-card" style="border-left: 4px solid ${color}">
                        <div class="card-header">
                            <span class="w-id">${w.name}</span>
                            <span style="background:${color}; color:#000; padding:2px 8px; border-radius:10px; font-size:0.8em; font-weight:bold">${s.risk}%</span>
                        </div>
                        <div class="stat-row"><span style="color:#888">HR</span><span style="color:#fff">${s.hr} BPM</span></div>
                        <div class="stat-row"><span style="color:#888">SPO2</span><span style="color:#fff">${s.spo2}%</span></div>
                        <div class="action-text">${s.action}</div>
                    </div>
                `;
            });
        }

        // --- SENSOR LOGIC (The New Part) ---
        function updateSensors() {
            // Pick one random sensor to update per tick (to keep feed moving)
            const s = sensors[Math.floor(Math.random() * sensors.length)];
            
            // Drift Value
            let change = (Math.random() - 0.5) * (s.base * 0.2);
            if (currentScenario === 'emergency' && Math.random() > 0.5) change += (s.limit * 0.3); // Spike!
            
            sensorState[s.id] = Math.max(0, parseFloat((sensorState[s.id] + change).toFixed(2)));
            const val = sensorState[s.id];
            
            // Determine Prediction
            let status = "NORMAL";
            let pred = "Stable Trend";
            
            if (val > s.limit * 0.8) { status = "WARNING"; pred = "âš ï¸ Rising Trend (+5m)"; }
            if (val > s.limit) { status = "CRITICAL"; pred = "ðŸš¨ FAILURE PREDICTED"; }
            
            // Add to Log
            addLog(s, val, status, pred);

            // Trigger Alarm if Critical
            if(status === "CRITICAL") triggerVisualAlarm(`${s.type} CRITICAL`);
        }

        function addLog(s, val, status, pred) {
            const feed = document.getElementById('env-feed');
            const div = document.createElement('div');
            div.className = 'env-entry';
            
            let color = status === 'CRITICAL' ? '#ff4444' : (status === 'WARNING' ? '#ffaa00' : '#00ff88');
            div.style.borderLeftColor = color;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                    <span style="color:${color}; font-weight:bold">${s.type}</span>
                    <span style="color:#666; font-size:0.9em">${s.zone}</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#fff; font-weight:bold; font-size:1.1em">${val} ${s.unit}</span>
                    <span style="color:#aaa; font-size:0.85em;">${pred}</span>
                </div>
            `;
            
            feed.prepend(div);
            if(feed.children.length > 15) feed.lastChild.remove();
        }

        // --- VISUALS ---
        function triggerVisualAlarm(msg) {
            const t = document.getElementById('twin-alert');
            t.innerText = "âš ï¸ " + msg;
            t.style.background = "red"; t.style.color = "white";
            setTimeout(() => {
                t.innerText = "LIVE TWIN | ZONE A";
                t.style.background = "rgba(0,0,0,0.7)"; t.style.color = "#00ffff";
            }, 2000);
        }

        function setScenario(s) {
            currentScenario = s;
            // Instant feedback
            document.querySelectorAll('button').forEach(b => b.style.opacity = 0.5);
            setTimeout(() => document.querySelectorAll('button').forEach(b => b.style.opacity = 1), 200);
        }

        // --- OPTIONAL: CONNECT TO REAL BRAIN ---
        try {
            socket = new WebSocket(BRAIN_WS);
            socket.onopen = () => {
                document.getElementById('conn-text').innerText = "CONNECTED (BRAIN)";
                document.getElementById('conn-text').style.color = "#00ff88";
                document.getElementById('conn-dot').style.background = "#00ff88";
            };
            socket.onmessage = (e) => {
                // If Python sends an alert, force it here
                const d = JSON.parse(e.data);
                if(d.type === 'environmental_alert') triggerVisualAlarm(d.title);
            }
        } catch(e) { console.log("Running in Standalone Mode"); }

        // START
        setInterval(masterLoop, 1500); // Fast paced updates

    </script>
</body>
</html>