<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SurakshaMesh Brain - Stable v3</title>
<style>
  body {
    background: #0a0a1a; color: #eee; font-family: sans-serif; padding: 20px;
  }
  .btn {
    background: #00ff88; color: #000; padding: 10px 20px; border: none;
    border-radius: 5px; font-weight: bold; cursor: pointer; margin-right: 10px;
  }
  .btn:disabled { background: #555; color: #888; cursor: not-allowed; }
  
  .grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px; margin-top: 20px;
  }
  .card {
    background: #1a1a2e; border-left: 5px solid #444; padding: 15px;
    border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
  .risk-high { border-left-color: #ff3333; }
  .risk-med { border-left-color: #ffaa00; }
  .risk-low { border-left-color: #00ff88; }
  
  .log-box {
    background: #000; color: #0f0; font-family: monospace; padding: 10px;
    height: 150px; overflow-y: auto; margin-top: 20px; border: 1px solid #333;
  }
  pre { margin: 5px 0; font-size: 0.85em; color: #aaa; }
</style>
</head>
<body>

<h1>ðŸ§  Brain Dashboard (Non-Blocking)</h1>

<div>
    <button id="connectBtn" class="btn">Connect</button>
    <button id="simBtn" class="btn" disabled>âš¡ Simulate Incident</button>
    <span id="status">Offline</span>
</div>

<div id="workerGrid" class="grid"></div>

<div class="log-box" id="consoleLog"></div>

<script>
    const WS_URL = 'ws://localhost:8002/ws/brain';
    let socket = null;
    const consoleLog = document.getElementById('consoleLog');
    const grid = document.getElementById('workerGrid');
    const simBtn = document.getElementById('simBtn');
    const statusSpan = document.getElementById('status');

    function log(msg) {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        consoleLog.appendChild(div);
        consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    function render(workers) {
        grid.innerHTML = '';
        workers.forEach(w => {
            const riskClass = w.risk >= 70 ? 'risk-high' : (w.risk >= 40 ? 'risk-med' : 'risk-low');
            const html = `
                <div class="card ${riskClass}">
                    <h3>${w.name} (${w.risk}%)</h3>
                    <p>Zone: ${w.zone}</p>
                    <pre>${JSON.stringify(w.insights || {}, null, 2)}</pre>
                </div>
            `;
            grid.innerHTML += html;
        });
    }

    document.getElementById('connectBtn').onclick = () => {
        if(socket) return;
        socket = new WebSocket(WS_URL);
        
        socket.onopen = () => {
            statusSpan.textContent = "Connected ðŸŸ¢";
            simBtn.disabled = false;
            log("Connected to Brain");
        };
        
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if (data.type === 'full_update') {
                render(data.workers);
            }
            
            if (data.type === 'incident_recorded') {
                log(`âš ï¸ INCIDENT SAVED: ${data.worker_id} (Risk: ${data.risk})`);
                if(data.actions) log(`ðŸ¤– Actions: ${data.actions.join(', ')}`);
            }
        };
        
        socket.onclose = () => {
            statusSpan.textContent = "Disconnected ðŸ”´";
            simBtn.disabled = true;
            log("Connection lost");
            socket = null;
        };
    };

    simBtn.onclick = () => {
        if(!socket) return;
        
        // COOLDOWN: Disable button for 1 second to prevent server flooding
        simBtn.disabled = true;
        setTimeout(() => simBtn.disabled = false, 1000);

        const risk = Math.floor(Math.random() * 30) + 70;
        log(`Sending simulation... Risk ${risk}`);
        
        socket.send(JSON.stringify({
            type: 'simulate_incident',
            worker_id: 'WKR-2401-M',
            risk: risk,
            zone: 'Furnace-A'
        }));
    };
</script>
</body>
</html>